<!DOCTYPE html>
<html>
<head>
<#include "/INC_HEAD.html">
<script type="text/javascript">
	function deleteBatch() {

		var chestr = getCheckedValues("productionId");
		document.getElementById("checkedProductionIds").value = chestr;
		artConfirmFun(null, myFun);
	}

	function myFun() {
	
		document.getElementById("deleteBatch").submit();
	}
</script>

</head>
<body>
	<div class="tab-nav">
         <ul class="nav"> 
             <li><a href="javascript:void(0)" class="active">可选商品</a></li> 
             <li><a href="javascript:void(0)" onclick="showCheckPdc()" id="pdcCheckInfo">已选商品(${couponCommSize!''})</a></li> 
         </ul> 
         <div style="clear:both;"></div>
    </div>
	<form id="queryFrm" action="commproduct?method=queryForCoupon" method="post">
       	<input type="hidden" id="entityPage.currentPage" name="entityPage.currentPage"  value="${pageInfo.pageNum!''}" />
		<input type="hidden" id="entityPage.sortField" name="entityPage.sortField" value="${entityPage.sortField!''}" /> 
		<input type="hidden" id="entityPage.sortOrder" name="entityPage.sortOrder" value="${entityPage.sortOrder!''}" />
		<input type="hidden" id="checkPdc" name="checkPdc" value="${commproduct.checkPdc!''}" />
		<input type="hidden" id="couponId" name="couponId" value="${commproduct.couponId!''}" />
		
<div class="data-requry">
	<table border="0" align="left" cellpadding="0" cellspacing="0">
        <tr>
          <td>商品名称：</td><td>
          	<input name="productName" type="text" class="data-searchtxt" id="title" value="${commproduct.productName!''}">
          </td>
          <td>商品编号：</td><td>
          	<input name="productCode" type="text" class="data-searchtxt" id="title" value="${commproduct.productCode!''}">
          </td>
          <td>是否上架：</td>
          <td>
          	<select  name="state" id="state" class="data-searchtxt-select">
          		<option value="">请选择</option>
          		<#if commproduct.state??>
          			<#if commproduct.state=='0'>
		         		<option value="0" selected="selected">否</option>
		         		<option value="1">是</option>
		         	<#elseif commproduct.state=='1'>
		         		<option value="0">否</option>
		         		<option value="1" selected="selected">是</option>
	          		<#else>
		         		<option value="0">否</option>
		         		<option value="1">是</option>
	          		</#if>
          		<#else>
	         		<option value="0">否</option>
	         		<option value="1">是</option>
          		</#if>
			</select>
          </td>
          <td align="right">
          	<input name="button" type="submit" class="data-searchbtn" id="button" value="查询"/>
        	
          </td>
          </tr>
            
      </table>
</div>
<#if productionlist?? && (productionlist?size>0)> 
<div style="height:290px;overflow:auto;">
<#else>
<div>
</#if>
		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="datalist" id="changecolor">
			<tr>
				<th width="4%" style="text-align:center"><input type="checkbox" id="allcheck" onclick="allCheck(this)"></th>
				<th width="12%">商品编号</th>
				<th width="30%">商品名称</th>
				<th width="13%">商家名称</th> 
				<th width="5%">商品状态</th>
				<th width="23%">选择范围</th>
			</tr>

			<#list productionlist as li>
			<tr>
				<td align="center">
					<input type="checkbox" id="check${li.productId!''}" name="delId" value="${li.productId!''}" onclick="checkPdcInfo(this,'${li.productId!''}')"></td>  
					<td>
						${li.productCode!''}
					</td>
					<td>
						${li.productName!''}
					</td>
					<td>
						${li.venName!''}
					</td> 
					<td>
						<#if li.state?? && li.state=='0'>
		                                                     下架
		                <#elseif li.state?? && li.state=='1'>
		                                                     上架
		                </#if>
					</td> 
					<td>
						<#list saleTypeList as s>
						<label><input class="saleType${li.productId!''}" id="saleType${s_index}" type="checkbox" value="${s.saleTypeKey!''}"  hidden onchange="changeSaleType(this,'${li.productId!''}')"/><label for="saleType${s_index}" class="check"></label>${s.saleTypeName!''}&nbsp;&nbsp;&nbsp;</label>
						</#list>
					</td> 
			</tr>
			</#list>
		</table>
</div>
		<#if productionlist?? && (productionlist?size>0)> 
			<#include "/pagination.html"> 
		<#else>
			<div id='ListIsNullMsg' style="font-size:17px;color:red">
				<script type="text/javascript">
					showListIsNullMsg();
				</script>
			</div>
		</#if>
	</form>
	<div class="footerbtn">   
		<input name="button3" onclick="beforeSubmit();" type="button" class="add-new" id="button3" value="确定">
		<input name="button4" type="button" onclick="cancel()" class="cbtn2" id="button4" value="取消">
	</div>
	<form action="production?method=deleteBatch" id="deleteBatch"
		method="post">
		<input type="hidden" name="checkedProductionIds"
			id="checkedProductionIds">
	</form>
<script>
// 单条商品 选中或非选中 处理
function checkPdcInfo(obj,pdcId){
	var checkInfo = $(obj).attr("checked");
	
	var deleteOrUpdate = "";
	var isCommon = "0";
	var isGroupPro ="0";
	var isSeckill = "0";
	if(checkInfo){
		var checkSaleType = false;
		$(".saleType"+pdcId).each(function(i){
			if($(this).attr("checked")){
				checkSaleType = true;
				if(i==0){
					isCommon = "1";
				}else if(i==1){
					isGroupPro = "1";
				}else if(i==2){
					isSeckill = "1";
				}
			}
			
		});
		if(!checkSaleType){
			isCommon = "1";
			$(".saleType"+pdcId).eq(0).attr("checked",true);
		}
		deleteOrUpdate = "add";
	}else{
		$(".saleType"+pdcId).attr("checked",false);
		deleteOrUpdate = "delete";
	}
	$.post("couponCommproduct?method=createOrUpdateCouponCommproduct",{
		couponId:$("#couponId").val(),
		useCouponPdcId:pdcId,
		useCouponPdcIdString:pdcId,
		isCommon:isCommon,
		isGroupPro:isGroupPro,
		isSeckill:isSeckill,
		deleteOrUpdate:deleteOrUpdate
	},function(data){
		if(data.resultCode=='0'){
			$("#pdcCheckInfo").html("已选商品("+data.resultMsg+")");
		}
	},'json');
}


// 切换已选商品
function showCheckPdc(){
	var url = "commproduct.do?method=queryForCoupon&checkPdc=1&couponId="+$("#couponId").val();
	window.location.href=url;
}

//取消
function cancel(){
	$.post("couponCommproduct?method=deleteCouponCommproductTemp",{
		couponId:$("#couponId").val()
	},function(data){
		parent.layer.closeAll();
	},'json');
}

//修改活动范围
function changeSaleType(obj,productId){
	var deleteOrUpdate = "";
	var isCommon = "0";
	var isGroupPro ="0";
	var isSeckill = "0";
	
	var checkSaleType = false;
	$(".saleType"+productId).each(function(i){
		if($(this).attr("checked")){
			checkSaleType = true;
			if(i==0){
				isCommon = "1";
			}else if(i==1){
				isGroupPro = "1";
			}else if(i==2){
				isSeckill = "1";
			}
		}
	});
	if(!checkSaleType){
		$("#check"+productId).attr("checked",false);
	}else{
		$("#check"+productId).attr("checked",true);
	}
	
	if(isCommon == "0" && isGroupPro=="0" && isSeckill=="0"){
		deleteOrUpdate = "delete";
	}else{
		deleteOrUpdate = "update";
	}
	$.post("couponCommproduct?method=createOrUpdateCouponCommproduct",{
		couponId:$("#couponId").val(),
		useCouponPdcId:productId,
		useCouponPdcIdString:productId,
		isCommon:isCommon,
		isGroupPro:isGroupPro,
		isSeckill:isSeckill,
		deleteOrUpdate:deleteOrUpdate
	},function(data){
		if(data.resultCode=='0'){
			$("#pdcCheckInfo").html("已选商品("+data.resultMsg+")");
		}
	},'json');
}

function beforeSubmit(){
	
}

</script>
</body>
</html>