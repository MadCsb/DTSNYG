<!DOCTYPE html>
<html>
<head><#include "/INC_HEAD.html">
</head>
<body>
	<!--主窗体-->
	<div class="waybill-title">
		<span>修改商家</span>
	</div>
		<form action="company.do?method=update" method="post" id="modifyCompany" enctype="multipart/form-data">
			<input type="hidden" name="venNameCompare" id="venNameCompare" value="${company.venName!''}"/>
			<input name="uName" type="text" class="data-inputtxt" id="uName" style="display:none">
			<input name="uHandphone" type="text" class="data-inputtxt" id="uHandphone" style="display:none">
			<input name="uDuty" type="text" class="data-inputtxt" id="uDuty" style="display:none">
			<input name="uTel" type="text" class="data-inputtxt" id="uTel" style="display:none">
			<input name="uFax" type="text" class="data-inputtxt"  id="uFax" style="display:none">
			<input name="uQQ" type="text" class="data-inputtxt" id="uQQ" style="display:none">
			<input name="uLinkId" type="text" class="data-inputtxt" id="uLinkId" style="display:none">
			<input name="lName" type="text" class="data-inputtxt" id="lName" style="display:none">
			<input name="lHandphone" type="text" class="data-inputtxt" id="lHandphone" style="display:none">
			<input name="lDuty" type="text" class="data-inputtxt" id="lDuty" style="display:none">
			<input name="lTel" type="text" class="data-inputtxt" id="lTel" style="display:none">
			<input name="lFax" type="text" class="data-inputtxt"  id="lFax" style="display:none">
			<input name="lQQ" type="text" class="data-inputtxt" id="lQQ" style="display:none">
			<input type="hidden" name="logoUrl" value="${company.logoUrl!''}"/>
			<input type="hidden" name="venId" id="venId" value="${company.venId!''}"/>
			<!--编辑区-->
			<table class="datalist-new" cellpadding="0" cellspacing="0" border="0" width="100%">
			<tbody id="list">
				<col style="width:20%"></col>
				<col style="width:30%"></col>
				<col style="width:20%"></col>
				<col style="width:30%"></col>
				<tr class="">
					<td colspan="4" style="height: 40px;color: #ACD6FF"><b>企业基础信息</b></td>
				</tr>
				<tr class="">
	              	<td width="20%" class="tdright"><b><font class="f2">*</font>商家名称：</b></td>
					<td width="30%"  colspan="3">
						<input name="venName" type="text" class="validate[required,maxSize[50]] data-inputtxt" 
	              	 	   id="venName" value="${company.venName!''}" onBlur="checkName(0)">
	              	 	<br>
	              	 	<font color="red" style="font-weight: bold;white-space: initial;"><strong><span id="msg"></span></strong></font>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>法人：</b></td>
					<td width="30%">
						<input name="leagal" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="leagal" value="${company.leagal!''}">
	              	 	<br>
	              	</td>
	              	<td width="20%" class="tdright"><b>主营业务：</b></td>
					<td width="30%">
						<input name="businessRange" type="text" class="validate[maxSize[500]] data-inputtxt" 
	              	 	   id="businessRange" value="${company.businessRange!''}">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>联系人：</b></td>
					<td width="30%">
						<input name="linkPerson" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="linkPerson" value="${company.linkPerson!''}">
	              	 	<br>
	              	</td>
					<td width="20%" class="tdright"><b>联系电话：</b></td>
					<td width="30%">
						<input name="linkTel" type="text" class="validate[maxSize[200],custom[mobile]] data-inputtxt" 
	              	 	   id="linkTel" value="${company.linkTel!''}">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>公司网址：</b></td>
					<td width="30%">
						<input name="wWWSite" type="text" class="validate[maxSize[50]] data-inputtxt" 
	              	 	   id="wWWSite" value="${company.wWWSite!''}">
	              	 	<br>
	              	</td>
					<td width="20%" class="tdright"><b>公司传真：</b></td>
					<td width="30%">
						<input name="fax" type="text" class="validate[maxSize[20]] data-inputtxt" 
	              	 	   id="fax" value="${company.fax!''}">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>公司详细地址：</b></td>
					<td width="30%" colspan="3">
						<input name="compAddress" type="text" class="validate[maxSize[500]] data-inputtxt" 
	              	 	   id="compAddress" value="${company.compAddress!''}" style="width:80%;">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
                          <td  class="tdright"><b>公司照片：</b></td>
                          <td colspan="3" class="Validform_checktip">
                          	<div id="pict" align="left">
							<p>
								<#if picurl??>
			                   		<img style="width:100px;" class="myimg" src="${rc.contextPath}/${picurl!''}" id="idImg" />
								<#else>
									<img style="width:100px;" class="myimg" src="${rc.contextPath}/images/no-tu.png" id="idImg"  />
								</#if> 
							</p>
							<p>
								<font color="red">图片只限jpg/gif/jpeg/png/bmp格式</font>
							</p>
							<input id="idFile" class="wabillText" style="cursor: pointer;" type="file" name="upload" onChange="changeImg();"  /> 
							<input class="imgbtn" type="button" id="btnqc" onClick="qingchu()" value=" 清 除 " />
						</div>
                          </td>
				</tr>
				<tr class="">
					<td colspan="4" style="height: 40px;color: #ACD6FF"><b>企业资质</b></td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>经营许可证：</b></td>
					<td width="30%">
						<input name="buscert" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="buscert" value="${company.buscert!''}">
	              	 	<br>
	              	</td>
					<td width="20%" class="tdright"><b>开户人名称：</b></td>
					<td width="30%">
						<input name="bankUser" type="text" class="validate[maxSize[100]] data-inputtxt" 
	              	 	   id="bankUser" value="${company.bankUser!''}">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>开户行名称：</b></td>
					<td width="30%">
						<input name="bankName" type="text" class="validate[maxSize[100]] data-inputtxt" 
	              	 	   id="bankName" value="${company.bankName!''}">
	              	 	<br>
	              	</td>
					<td width="20%" class="tdright"><b>开户行账号：</b></td>
					<td width="30%">
						<input name="bankAcc" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="bankAcc" value="${company.bankAcc!''}">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>银行税号：</b></td>
					<td width="30%">
						<input name="bankTax" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="bankTax" value="${company.bankTax!''}">
	              	 	<br>
	              	</td>
					<td width="20%" class="tdright"><b>注册资金：</b></td>
					<td width="30%">
						<input name="fund" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="fund" value="${company.fund!''}">元
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td colspan="4" style="height: 40px;color: #ACD6FF"><b>联系人</b></td>
				</tr>
				<#if linkinfoList?? && (linkinfoList?size>0)>
        		<#list linkinfoList as linkinfo>
        		<tr class="">
        			<input name="linkId${linkinfo.size!''}" type="text" class="data-inputtxt" id="linkId${linkinfo.size!''}" value="${linkinfo.linkId!''}" style="display:none">
					<td width="20%" class="tdright"><b>姓名：</b></td>
					<td width="30%">
						<input name="name${linkinfo.size!''}" type="text" class="validate[required,maxSize[20]] data-inputtxt" 
	              	 	   id="name${linkinfo.size!''}" value="${linkinfo.name!''}">
	              	 	<br>
	              	</td>
	              	<td width="20%" class="tdright"><b>手机：</b></td>
					<td width="30%">
						<input name="handphone${linkinfo.size!''}" type="text" class="validate[required,maxSize[30],custom[mobile]] data-inputtxt" 
	              	 	   id="handphone${linkinfo.size!''}" value="${linkinfo.handPhone!''}">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>职务：</b></td>
					<td width="30%">
						<input name="duty${linkinfo.size!''}" type="text" class="validate[maxSize[100]] data-inputtxt" 
	              	 	   id="duty${linkinfo.size!''}" value="${linkinfo.duty!''}">
	              	 	<br>
	              	</td>
	              	<td width="20%" class="tdright"><b>办公电话：</b></td>
					<td width="30%">
						<input name="tel${linkinfo.size!''}" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="tel${linkinfo.size!''}" value="${linkinfo.tel!''}">
	              	 	<br>
	              	</td>
				</tr>
				<tr class="">
					<td width="20%" class="tdright"><b>传真：</b></td>
					<td width="30%">
						<input name="fax${linkinfo.size!''}" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="fax${linkinfo.size!''}" value="${linkinfo.fax!''}">
	              	 	<br>
	              	</td>
	              	<td width="20%" class="tdright"><b>QQ：</b></td>
					<td width="30%">
						<input name="QQ${linkinfo.size!''}" type="text" class="validate[maxSize[30]] data-inputtxt" 
	              	 	   id="QQ${linkinfo.size!''}" value="${linkinfo.qq!''}">
	              	 	<br>
	              	</td>
				</tr>
        		</#list>
        		</#if>
				
				<tr class="" id="addOne">
					<td></td>
					<td colspan="3">
						<input name="button3" onClick="addNew()" type="button" class="add-new" id="button3" value="新增一条">
					</td>
				</tr>
				<tr class="">
                	<td valign="top" class="tdright"><b>商家备注：</b></td>
                    <td colspan="3">
						<textarea name="venMemo" id="venMemo" rows="4" cols="80" style="width:97%">${company.venMemo!''}</textarea>
					</td>
                </tr>
                
                <tr class="">
					<td colspan="4" style="height: 40px;color: #ACD6FF"><b>退货信息</b></td>
				</tr>
                <tr class="">
					<td width="20%" class="tdright"><b><font class="f2">*</font>收货人：</b></td>
					<td width="30%">
						<input name="receiver" type="text" class="validate[required,maxSize[100]] data-inputtxt" 
	              	 	   id="receiver" value="${company.receiver!''}">
	              	 	<br>
	              	</td>
					<td width="20%" class="tdright"><b><font class="f2">*</font>收货人电话：</b></td>
					<td width="30%">
						<input name="recvPhone" type="text" class="validate[required,maxSize[11],custom[mobile]] data-inputtxt" maxlength="11"
	              	 	   id="recvPhone" value="${company.recvPhone!''}">
	              	 	<br>
	              	</td>
				</tr>
				
				<tr class="">
					<td class="tdright"><b><font class="f2">*</font>收货地址：</b></td>
					<td colspan="3">
						<input name="recvAddress" type="text" class="validate[required,maxSize[500]] data-inputtxt" 
	              	 	   id="recvAddress" style="width:80%;" value="${company.recvAddress!''}">
	              	 	<br>
	              	</td>
				</tr>
			</tbody>
		</table>
			<!--操作区-->
			<div class="footerbtn">   

				<input name="button4" type="button" onClick="javascript:location.href='${Session.BACK_URL!""}'" class="cbtn2" id="button4" value="取消">
				<input name="button3" onClick="beforeSubmit();" type="button" class="cbtn1" id="button3" value="确认">
			</div>
		</form>
	</div>
</body>
<script type="text/javascript">


//验证商家名称是否重复(flag:0-光标离开；1-提交保存)
function checkName(flag) {
	var venName = $("#venName").val();
	var venId = $("#venId").val();

	if (venName != "") {
		$.ajax({
			type: "POST",
			url:"company?method=checkVenName",  
			data: {
				venName : venName,
				venId : venId
			},
			success: function(data){
				if (data != null) {
					if (data == "0") {
						$("#msg").html("");
						
						if (flag == 1) {

							// 提交保存
			  				afterCheckName();
						}
					} else {
						$("#venName").val("");
						$("#msg").html("商家名称【" + venName + "】已被使用，请重新输入商家名称！");
					}			
				}
			}	
		});
	}
}

//保存前
function beforeSubmit() {
	if ($("#modifyCompany").validationEngine('validate')) {
		
		var receiver = $("#receiver").val().trim();
		if (receiver == "") {
			art.dialog.alert("收货人不能为空");
			return false;
		}

		var recvPhone = $("#recvPhone").val().trim();
		if (recvPhone == "") {
			art.dialog.alert("收货人电话不能为空");
			return false;
		}

		var recvAddress = $("#recvAddress").val().trim();
		if (recvAddress == "") {
			art.dialog.alert("收货地址不能为空");
			return false;
		}
		
		// 重名验证，验证通过后提交
		checkName(1);
	}
}

//重名验证通过后
function afterCheckName(){

	if(getStrLength(CKEDITOR.instances.venMemo.getData()) > 4000){
		art.dialog.alert("商家备注内容过长");
		return false;
	}
	
	//修改当前联系人
	var name = "1";
	var handphone = "1";
	var duty = "1";
	var tel = "1";
	var fax = "1";
	var QQ = "1";
	var linkId = "1";
	for (var i = 0; i < 2; i++)  {
		var uName = "name"+i;
		var uHandphone = "handphone"+i;
		var uDuty = "duty"+i;
		var uTel = "tel"+i;
		var uFax = "fax"+i;
		var uQQ = "QQ"+i;
		var uLinkId = "linkId"+i;
		name += ", " + $("#"+uName+"").val();
		handphone += ", " + $("#"+uHandphone+"").val();
		duty += ", " + $("#"+uDuty+"").val();
		tel += ", " + $("#"+uTel+"").val();
		fax += ", " + $("#"+uFax+"").val();
		QQ += ", " + $("#"+uQQ+"").val();
		linkId += ", " + $("#"+uLinkId+"").val();
	}
	$("#uName").val(name);
	$("#uHandphone").val(handphone);
	$("#uDuty").val(duty);
	$("#uTel").val(tel);
	$("#uFax").val(fax);
	$("#uQQ").val(QQ);
	$("#uLinkId").val(linkId);
	
	//添加新联系人
	name = "1";
	handphone = "1";
	duty = "1";
	tel = "1";
	fax = "1";
	QQ = "1";
	for (var i = 1; i < num; i++) {
		var lName = "lName"+i;
		var lHandphone = "lHandphone"+i;
		var lDuty = "lDuty"+i;
		var lTel = "lTel"+i;
		var lFax = "lFax"+i;
		var lQQ = "lQQ"+i;
		if($("#"+lName+"").size()>0){
			name += ", " + $("#"+lName+"").val();
			handphone += ", " + $("#"+lHandphone+"").val();
			duty += ", " + $("#"+lDuty+"").val();
			tel += ", " + $("#"+lTel+"").val();
			fax += ", " + $("#"+lFax+"").val();
			QQ += ", " + $("#"+lQQ+"").val();
		}
	}
	
	$("#lName").val(name);
	$("#lHandphone").val(handphone);
	$("#lDuty").val(duty);
	$("#lTel").val(tel);
	$("#lFax").val(fax);
	$("#lQQ").val(QQ);
	
	if($("#isgyTicket").is(':checked')) {
		$("#isgyTicket").val("1");
	}
	if($("#isgyLine").is(':checked')) {
		$("#isgyLine").val("1");
	}
	if($("#isgyHotel").is(':checked')) {
		$("#isgyHotel").val("1");
	}
	if($("#isgyCommproduct").is(':checked')) {
		$("#isgyCommproduct").val("1");
	}

	$("#modifyCompany").submit();
}

var num = 1;
function addNew(){
	var html = "";
	var n = num +1;
	html += '<tr class=""> ';
	html += '<td width="20%" class="tdright"><b>姓名：</b></td> ';
	html += '<td width="30%"> ';
	html += '<input name="lName'+num+'" type="text" class="validate[maxSize[20]] data-inputtxt" id="lName'+num+'"> ';
	html += '<br> </td> ';
	html += '<td width="20%" class="tdright"><b>手机：</b></td> <td width="30%"> ';
	html += '<input name="lHandphone'+num+'" type="text" class="validate[maxSize[30]] data-inputtxt" id="lHandphone'+num+'"> ';
	html += '<br> </td> </tr> <tr class=""> ';
	html += '<td width="20%" class="tdright"><b>职务：</b></td><td width="30%"> ';
	html += '<input name="lDuty'+num+'" type="text" class="validate[maxSize[100]] data-inputtxt" id="lDuty'+num+'"> ';
	html += '<br> </td> ';
	html += '<td width="20%" class="tdright"><b>办公电话：</b></td><td width="30%"> ';
	html += '<input name="lTel'+num+'" type="text" class="validate[maxSize[30]] data-inputtxt" id="lTel'+num+'"> ';
	html += '<br> </td> </tr> <tr class="" id="'+n+'">';
	html += '<td width="20%" class="tdright"><b>传真：</b></td><td width="30%"> ';
	html += '<input name="lFax'+num+'" type="text" class="validate[maxSize[30]] data-inputtxt" id="lFax'+num+'"> ';
	html += '<br> </td> ';
	html += '<td width="20%" class="tdright"><b>QQ：</b></td><td width="30%"> ';
	html += '<input name="lQQ'+num+'" type="text" class="validate[maxSize[30]] data-inputtxt" id="lQQ'+num+'"> ';
	html += '<br> </td> </tr> <tr class=""> <td> </td> ';
	html += '<td colspan="3"> ';
	html += '<input name="button3" onclick="deleteOne(this);" type="button" class="add-new" id="button3" value="删除"> ';
	html += '</td> </tr> ';
	$(html).insertBefore("#addOne");
	num++;
}

function deleteOne(obj){
	var tr = obj.parentNode.parentNode;
	tr.previousElementSibling.remove();
	tr.previousElementSibling.remove();
	tr.previousElementSibling.remove();
	tr.remove();
}


//描述复文本
var m_cke = null;

	// 页面初始化
 	$(function(){
 		
 		// 加载验证框架
	$("#modifyCompany").validationEngine();
 		
 		// 初始化描述
	initDescription();
 		
});
	
// 初始化描述
function initDescription() {
	m_cke = CKEDITOR.replace('venMemo');
}

// 页面大小改变事件
$(window).resize(function(){
	var descriptionWidth = $("#venMemo").css("width").replace("px", "") * 1 - 20;
	$("#cke_venMemo").css("width", descriptionWidth + "px");
});

function qingchu(){
	var newtd ='<p><img class="myimg"  id="idImg" src="" style="display: none"/></p>'
       			+'<p><img id="localImag" style="display: none"/></p>'
       			+'<p><font color="red">图片只限jpg/gif/jpeg/png/bmp格式，尺寸为300x205px</font></p>'
       			+'<input id="idFile" class="wabillText" style="cursor: pointer;" type="file" name="upload" onchange="changeImg();" />'
			 	+'<input class="imgbtn" type="button" id="btnqc" onclick="qingchu()" value=" 清 除 " />';
	$("#pict").html(newtd);
}
//----------图片预览（条件判断）-------------
function yulan(){ 
	var fileext=document.getElementById("idFile").value.substring(document.getElementById("idFile").value.lastIndexOf("."),document.getElementById("idFile").value.length);
	fileext=fileext.toLowerCase();
 	if ((fileext!='.jpg')&&(fileext!='')&&(fileext!='.gif')&&(fileext!='.jpeg')&&(fileext!='.png')&&(fileext!='.bmp')){
         art.dialog.alert("对不起，系统仅支持jpg/gif/jpeg/png/bmp格式的照片，请您调整格式后重新上传，谢谢 ！");
         document.getElementById("idFile").focus();
         return false;
 	}
	 return true;
}
//---------------切换图片----------------------------
function changeImg(){
 	if(!yulan()){
		document.getElementById("idFile").value = null;
		return false;
	} 
    var MAXWIDTH = "300px";
	var MAXHEIGHT = "205px";
	var img = document.getElementById("idImg");
	img.style.display="";
	var file = document.getElementById("idFile");
	
	if(file.files && file.files[0]){       
        var reader = new FileReader();
        reader.onload = function(evt){
        	img.src = evt.target.result; 
    	}
        reader.readAsDataURL(file.files[0]);
	}else{
		file.select();
		var imgSrc = document.selection.createRange().text;  
		var localImagId = document.getElementById("localImag");  
		localImagId.style.display="block";
		localImagId.style.width = MAXWIDTH;          
      　　	localImagId.style.height = MAXHEIGHT;  
      　　	localImagId.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";  　　	  
      　　	localImagId.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;  
      　　	img.style.display = 'none';  	  
      　　	document.selection.empty();  
	}
}

function getStrLength(inputStr){
	inputStr = inputStr.replace(/\n/g,"11");
    var i = 0;
    var totalLength = 0;
    /* 计算utf-8编码情况下的字符串长度 */
    for ( i = 0 ; i < inputStr .length ; i++){
          if ( inputStr.charCodeAt(i) <= parseInt ("0x7F") ){
                totalLength += 1;
          }
          else if (inputStr.charCodeAt(i) <= parseInt ("0x7FF")){
                totalLength += 2;
          }
          else if (inputStr.charCodeAt(i) <= parseInt("0xFFFF")){
                totalLength += 3;
          }
          else if (inputStr.charCodeAt(i) <= parseInt("0x1FFFFF")){
                totalLength += 4;
          }
          else if (inputStr.charCodeAt(i) <= parseInt("0x3FFFFFF")){
                totalLength += 5;
          }
          else{
                totalLength += 6;
          }
    }
    
    return totalLength;
}
</script>
</html>
