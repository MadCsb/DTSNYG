<!DOCTYPE html>
<html>
<head>
	<#include "WEB_PERSONAL_INC_HEAD.html"/>
	<script type="text/javascript" src="${rc.contextPath}/plugin/DatePicker/WdatePicker.js"></script>
	<script type="text/javascript" src="${rc.contextPath}/web/js/jquery.page.js"></script>
</head>
<body>
<#include "PersonalTop.html"/>
<input type="hidden" id="orderListType" value="${orderListType}">
<div class="order_content">
	<div class="order_content_title clearfix ordernav">
		<input type="hidden" name="app" value="userorder">
		<p class="order_types order_types_part01">
			<a onclick="changeOrderListType('0')">全部订单</a>
			<a onclick="changeOrderListType('1')">待支付</a>
			<a onclick="changeOrderListType('2')">待发货</a>
			<a onclick="changeOrderListType('3')">待收货</a>
			<a onclick="changeOrderListType('4')">退换货</a>
		</p>
		<p class="order_time">
			<span>下单时间</span>
			<input type="text" autocomplete="off" placeholder="开始时间" id="createTimeS" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" class="text w70 hasDatepicker" readonly="readonly">
			<label class="add-on">
				<i class="iconfont icon-rili"></i>
			</label>
			<em style="margin-top: 3px;">&nbsp;– &nbsp;</em>
			<input type="text" placeholder="结束时间" autocomplete="off" id="createTimeE" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" class="text w70 hasDatepicker" readonly="readonly">
			<label class="add-on">
				<i class="iconfont icon-rili"></i>
			</label>
		</p>
		<p class="ser_p" style="margin-left: 10px; width:300px;">
			<input type="text" id="orderCodeLike" value="" placeholder="订单号">
			<a class="button btn_search_goods" onclick="orderSearch()" style="padding-left: 2px;"><i class="iconfont icon-icosearch icon_size18" style="margin-right:-2px; "></i>搜索</a>
		</p>
	</div>

	<table>
		<tbody class="tbpad">
		<tr class="order_tit">
			<th class="order_goods">商品</th>
			<th class="widt1">单价</th>
			<th class="widt5">数量</th>
			<th class="widt4">活动类型</th>
			<th class="widt5">订单金额</th>
			<th class="widt6">交易状态</th>
			<th class="widt4">交易操作</th>
		</tr>
		</tbody>
		<tbody>
		<tr>
			<th class="tr_margin" style="height:16px;background:#fff;" colspan="8"></th>
		</tr>
		</tbody>

		<tbody class="tboy">
		</tbody>

		<tbody>
		<tr>
			<th class="tr_margin" style="height:16px;background:#fff;" colspan="8"></th>
		</tr>
		</tbody>

		<tfoot>
		<tr>
			<td colspan="19">
				<div class="pagination">
					<ul id="fenye">

					</ul>
				</div>
			</td>
		</tr>
		</tfoot>
	</table>
</div>





<#include "PersonalButton.html"/>
<script>
  var searchObject = new Object(); //查询对象
  searchObject.userId = "${user.userId}";
  var pageEntity = new Object(); //查询 分页对象
  pageEntity.pageNum = null;
  pageEntity.pageSize = 10; //每次查询十条订单

  $(function () {
    var orderListType = $("#orderListType").val();
    if(orderListType == "")
    {
      orderListType="0";
    }
    changeOrderListType(orderListType);
  })

  function orderSearch()
  {
  	alert($("#orderListType").val());
    changeOrderListType($("#orderListType").val());
  }

  //修改orderListType,查询订单列表
  function changeOrderListType(orderListType)
  {
    pageEntity.pageNum = 1;
    //修改选中样式
    $(".order_types_part01").find("a").each(function (index) {
      if(index == parseInt(orderListType)) //选中
      {
        $(this).attr("class","currect");
      }else //没选中
      {
        $(this).removeAttr("class");
      }
    })

    //修改当前选中的订单类型
    $("#orderListType").val(orderListType);
    if (orderListType == '0') // 全部订单
    {
      searchObject.payTag = "";
      searchObject.beforePayStatus = "";
      searchObject.status = ""
      searchObject.backNumS = "";
    }else if (orderListType == '1') // 待支付
    {
      searchObject.payTag = "0";
      searchObject.beforePayStatus = "0";
      searchObject.status = ""
      searchObject.backNumS = "";
    }else if (orderListType == '2') // 待发货
    {
      searchObject.payTag = "1";
      searchObject.beforePayStatus = "";
      searchObject.status = "0";
      searchObject.backNumS = "";
    }else if (orderListType == '3') // 待收货
    {
      searchObject.payTag = "1";
      searchObject.beforePayStatus = "";
      searchObject.status = "1"
      searchObject.backNumS = "";
    }else if (orderListType == '4') // 退换货
    {
      searchObject.payTag = "1";
      searchObject.beforePayStatus = "";
      searchObject.status = ""
      searchObject.backNumS = "1";
    }
    queryOrderList();
  }
  //查询订单列表，填充
  function queryOrderList()
  {
    searchObject.searchKey = $("#searchKey").val();
    searchObject.createTimeS = $("#createTimeS").val();
    if(searchObject.createTimeS != '')
	{
		searchObject.createTimeS = searchObject.createTimeS + " 00:00:00";
	}
    searchObject.createTimeE = $("#createTimeE").val();
    if(searchObject.createTimeE != '')
	{
	 searchObject.createTimeE = searchObject.createTimeE + " 23:59:59";
	}
    searchObject.orderCodeLike = $("#orderCodeLike").val();
    $(".tboy").html(""); //清空
    var result = ajaxOrderList(false,searchObject,pageEntity); //同步加载

    var pageInfo = result.pageInfo;
    var orderList = pageInfo.list;

    for(var i=0;i<orderList.length;i++)
    {
      var liHtml = '<tr class="tr_title">'
          + '<th colspan="8" class="order_mess">'
          + '<p class="order_mess_one">'
          + '<time>下单时间：'+orderList[i].createTime+'</time>'
          + '<span>订单号：<strong>'+orderList[i].orderCode+'</strong></span>'
          + '</p>'
          + '<div class="order_promotion_type"><span></span><span></span></div>'
          + '</th>'
          + '</tr>'
					+	'<tr detailOrderId="'+orderList[i].orderId+'"></tr>';
      $(".tboy").append(liHtml);
    }
    for(var i=0;i<orderList.length;i++)
    {
      ajaxOrderDetail(true,orderList[i].orderId,orderDetailShow); //异步获取订单，通过orderDetailShow方法处理订单
    }

    var pageCount = pageInfo.pages;
    var current = pageInfo.pageNum;
    $("#fenye").createPage({
      pageCount:pageCount,
      current:current,
      backFn:function(p){
        pageEntity.pageNum = p;
        queryOrderList();
      }
    });
  }

  //获取订单分类
  //"-"已退订 "--"退款中  "0-0"未支付未关闭，"0-12".未支付已关闭，"1-0"已支付待确认，"1-1"已支付已发货，"1-2"已支付已收货,"1-5"订单已关闭
  function getOrderShowType(order)
  {
    var orderShowType = null;
    if (order.backNum != null && order.backNum != '0') //"-"已退订
    {
      orderShowType="-";
    }else if (order.backTimes != null && order.backTimes != '0') //退订中
    {
      orderShowType="--";
    }else
    {
      if(order.payTag == "0" && order.beforePayStatus == "0") //"0-0"未支付未关闭
      {
        orderShowType = "0-0";
      }else if(order.payTag == "0" && (order.beforePayStatus == "1" || order.beforePayStatus == "2")) //"0-12".未支付已关闭
      {
        orderShowType = "0-12";
      }else if(order.payTag == "1" && order.status == "0") //"1-0"已支付待确认
      {
        orderShowType = "1-0";
      }else if(order.payTag == "1" && order.status == "1") //"1-1"已支付已发货
      {
        orderShowType = "1-1";
      }
      else if(order.payTag == "1" && order.status == "2") //"1-2"已支付已收货
      {
        orderShowType = "1-2";
      }else if(order.payTag == "1" && order.status == "3") //"1-3" 确认拒绝
      {
        orderShowType = "1-3";
      }else if(order.payTag == "1" && order.status == "5") //"1-5"订单已关闭
      {
        orderShowType = "1-5";
      }
    }
    return orderShowType;
  }
  //订单扩展显示
  var orderDetailShow = function queryOrderDetail(orderDetail)
  {
    var orderListList = orderDetail.orderListList;
    var order = orderDetail.order;
    var orderShowType = getOrderShowType(order);

    var detailHtml =  '<td colspan="4" class="td_rborder">' +
        '<table><tbody>';
    for(var j=0;j<orderListList.length;j++)
    {
      //退订单，不显示
      if(orderListList[j].orderListType == '1')
      {
        continue;
      }
      detailHtml = detailHtml +
          '<tr class="tr_con shop-list">' +
          '<td class="order_goods">' +
          '<img src="${rc.contextPath}/upload/wxpic/'+ orderListList[j].goodsPrice.thumbPic+'">' +
          '<a target="_blank" href="">'+orderListList[j].productName+'</a>' +
          '<em class="td_sale bbc_btns small_details">'+ orderListList[j].childName +'</em>' +
          '</td>' +
          '<td class="td_color widt1">'+ orderListList[j].price +'</td>' +
          '<td class="td_color widt2"><div class="cart-spec"><a class="spec-title" title=""><i class="iconfont icon-cuowu" style="position:relative;font-size: 12px;">' +
          '</i>'+ orderListList[j].num +'</a>' +
          '</div></td>' +
          '<td class="td_color widt4">';
      if(orderListList[j].sellPrice.priceType == '0')
      {
        detailHtml = detailHtml+ '普通'
      }else if(orderListList[j].sellPrice.priceType == '1')
      {
        detailHtml = detailHtml+ '团购商品'
      }else if(orderListList[j].sellPrice.priceType == '2')
      {
        detailHtml = detailHtml+ '秒杀商品'
      }
      detailHtml = detailHtml + '</td></tr>';
    }
    detailHtml = detailHtml + '</tbody></table>' +
        '</td>' +
        '<td class="td_rborder widt5">' +
        '<span>订单总额：<strong>¥'+order.money+'</strong></span>' +
        '<br>运费：'+order.transFee+'<br><span class="td_sale bbc_btns"></span>' +
        '</td>' +
        '<td class="td_rborder">' +
        '<p class="getit "></p>' +
        '<p><span style="color:#36C">'
    if(orderShowType == "-")
    {
      detailHtml += '已退款'
    }else if(orderShowType == "--")
    {
      detailHtml += '退款中'
    }else if(orderShowType == "0-0")
    {
      detailHtml += '待支付'
    }else if(orderShowType == "0-12")
    {
      detailHtml += '已取消'
    }else if(orderShowType == "1-0")
    {
      detailHtml += '待发货'
    }else if(orderShowType == "1-1")
    {
      detailHtml += '待收货'
    }else if(orderShowType == "1-2")
    {
      detailHtml += '已收货'
    }else if(orderShowType == "1-5")
    {
      detailHtml += '订单关闭'
    }
    detailHtml = detailHtml+'</span><br></p>' +
        '<p><a href="">订单详情</a></p>' +
        '</td>' +
        '<td class="td_rborder">';
    //"-"已退订 "--"退款中  "0-0"未支付未关闭，"0-12".未支付已关闭，"1-0"已支付待确认，"1-1"已支付已发货，"1-2"已支付已收货,"1-5"订单已关闭
    if(orderShowType == "-")
    {
      detailHtml += '<a onclick="toOrderBackDetail(\''+order.orderId+'\')" style="color:#F30;" class="to_views">查退款</a>'
    }else if(orderShowType == "--")
    {
      detailHtml += '<a onclick="toOrderBackDetail(\''+order.orderId+'\')" style="color:#F30;" class="to_views">查退款</a>'
    }else if(orderShowType == "0-0")
    {
      detailHtml += '<a onclick="toWebPayOrder(\''+order.orderId+'\')" style="color:#F30;" class="to_views">去支付</a>'
    }else if(orderShowType == "0-12") //已取消
    {
    }else if(orderShowType == "1-0") //待发货
    {
      detailHtml += '<a onclick="toWebAlertMsg(\'已提醒尽快发货，如有疑问，请致电400-8013841\')" style="color:#F30;" class="to_views">提醒</a>';
    }else if(orderShowType == "1-1")
    {
      detailHtml += '<a onclick="toOrderExpress(\''+order.orderId+'\')" style="color:#F30;" class="to_views">查物流</a>';
    }else if(orderShowType == "1-2")
    {
      detailHtml += '<a onclick="toOrderBack(\''+order.orderId+'\')" style="display: none;" style="color:#F30;" class="to_views">申请退货</a>';
    }else if(orderShowType == "1-3")
    {

    }else if(orderShowType == "1-5")
    {

    }
    detailHtml = detailHtml + '</td>';
    $("[detailOrderId='"+order.orderId+"']").html(detailHtml);
  }
</script>
</body>
</html>