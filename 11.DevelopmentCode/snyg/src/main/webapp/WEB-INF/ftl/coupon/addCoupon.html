<!DOCTYPE html>
<html>
<head><#include "/INC_HEAD.html">
</head>

<body>
	<div class="waybill-title">
		<span>新增优惠券</span>
	</div>
		<form action="coupon?method=add" method="post" id="createCoupon">
			<input name="status" type="hidden" id="status" size="40" />
			<input name="sellPriceIdList" type="hidden" size="600" id="sellPriceIdList" size="40" />
			
			<!--编辑区-->
			<table class="datalist-new" cellpadding="0" cellspacing="0" border="0" width="100%">
				<tr>
					<td width="13%" class="tdright"><b><font class="f2">*</font>优惠券名称：</b></td>
					<td width="35%"><input name="name" type="text" class="validate[required,maxSize[100]] data-inputtxt" 
						id="productName" size="40"/>
					</td>
					<td width="15%" class="tdright"><b><font class="f2">*</font>领取方式：</b></td>
					<td width="50%">
						<label><input name="obtainType" id="obtainType1" type="radio" value="1"  checked hidden/><label for="obtainType1" class="radiock"></label>商品页领取&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
	           			<label><input name="obtainType" id="obtainType2" type="radio" value="2"  hidden/><label for="obtainType2" class="radiock"></label>活动页领取</label>
					</td>
				</tr>
				<tr>
					<td class="tdright"><b><font class="f2">*</font>发行总量：</b></td>
					<td><input name="totalNum" type="text" class="validate[required,maxSize[10],custom[integer1-9999999999]] data-inputtxt" 
						id="totalNum" size="40" />
					</td>
					<td class="tdright"><b>每日发行量：</b></td>
					<td>
						<input name="dayNum" type="text" class="validate[maxSize[10],custom[integer1-9999999999]] data-inputtxt" 
						id="dayNum" size="40"/>
					</td>
				</tr>
				<tr>
					<td class="tdright"><b><font class="f2">*</font>使用限制：</b></td>
					<td>单笔订单中此优惠券的指定商品金额值<br>
						<select name="useType" id="useType" onchange="changeUserType()" class="data-inputtxt-select" style="width:60px;">
							<option value="1">满</option>
							<option value="2">打折</option>
						</select>
						<input name="useLimit" type="text"
						id="useLimit" size="40" style="width:130px;" class="validate[required,custom[num8point2]] data-inputtxt"/>元，使用
					</td>
					<td class="tdright"><b><span class="f2"><b>*</b></span><span id="useTypeSpan1">抵扣：</span></b></td>
					<td>
						<span id="useTypeSpan2">减</span>&nbsp;&nbsp;<input name="discount" type="text"
						id="discount" size="40" style="width:175px;" class="validate[required,maxSize[10],custom[num8point2]] data-inputtxt"/>
						<span id="useTypeSpan3">元</span><br>
						<span style="color:red;" id="useTypeSpan4">抵扣金额不能大于满足金额的80%</span>
					</td>
				</tr>
				<tr>
					<td class="tdright"><b><font class="f2">*</font>每人限领：</b></td>
					<td><input name="obtainLimit" type="text" class="validate[required,maxSize[10],custom[integer1-9999999999]] data-inputtxt" 
						id="obtainLimit" size="40" />
					</td>
					<td class="tdright"><b><font class="f2">*</font>每人每天限领：</b></td>
					<td>
						<input name="dayObtainLimit" type="text" class="validate[maxSize[10],custom[integer1-9999999999]] data-inputtxt" 
						id="dayObtainLimit" size="40" />
					</td>
				</tr>
				<tr>
					<td class="tdright"><b><font class="f2">*</font>券有效期：</b></td>
					<td colspan="3"><input name="validBegin" type="text"
						id="validBegin" size="40" class="validate[required,maxSize[23]] data-searchtxt-time" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'#F{$dp.$D(\'validEnd\')}'})" readonly="readonly"/>
						- 
						<input name="validEnd" type="text"
						id="validEnd" size="40" class="validate[required,maxSize[23]] data-searchtxt-time" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'validBegin\')}'})" readonly="readonly"/>
					</td>
				</tr>
				<tr>
					<td class="tdright"><b><font class="f2">*</font>领券有效期：</b></td>
					<td>
						<select name="obtainDateType" id="obtainDateType" onchange="changeobtainDateType()" class="data-inputtxt-select">
							<option value="1">有效时段</option>
							<option value="2">有效时长</option>
						</select>	
					</td>
					<td class="tdright"><b><font class="f2">*</font>有效时段：</b></td>
					<td>
						<span id="obtainDateTypeSpan2">
						<input name="obtainDateBegin" type="text"
						id="obtainDateBegin" size="40" class="validate[required,maxSize[23]] data-searchtxt-time" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',maxDate:'#F{$dp.$D(\'validEnd\')}',minDate:'#F{$dp.$D(\'validBegin\')}'})" readonly="readonly"/>
						- 
						<input name="obtainDateEnd" type="text"
						id="obtainDateEnd" size="40" class="validate[required,maxSize[23]] data-searchtxt-time" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'obtainDateBegin\')}',maxDate:'#F{$dp.$D(\'validEnd\')}'})" readonly="readonly"/>
						</span>
						<span id="obtainDateTypeSpan3" style="display:none;">
							<input name="obtainDateSpan" type="text" id="obtainDateSpan" class="validate[required,maxSize[2],custom[integer]] data-inputtxt" size="40" />天
						</span>
					</td>
				</tr>
				<tr >
					<td class="tdright"><b><span class="f2"><b>*</b></span>使用范围：</b></td>
					<td  colspan="3" style="line-height:47px;">
	              		<label><input name="couponType" id="couponType1" onclick="couponTypeChange('1')" type="radio" value="1" checked hidden><label for="couponType1" class="radiock"></label>全部商品&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
	              		<label><input name="couponType" id="couponType2" onclick="couponTypeChange('2')" type="radio" value="2" hidden><label for="couponType2" class="radiock"></label>指定商品&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
					</td>
				</tr>
				<tr id="couponType2Td" style="display:none;">
					<td class="tdright"></td>
					<td  colspan="3" style="min-height:50px;">
						<span >已选：商品&nbsp;&nbsp;<span id="pdcNum" style="color:#FF6600">0</span>&nbsp;&nbsp;个</span>&nbsp;&nbsp;&nbsp;&nbsp;<input onclick="choosePdc();" type="button" class="add-new" id="button3" style="margin-top:10px;margin-bottom:10px;" value="选择商品">
						<input onclick="delMorePdc()" type="button" class="add-new" id="button4" style="margin-top:10px;margin-bottom:10px;" title="删除" value="删除">
						<table id="checkPdcTable"  class="datalist" cellpadding="0" cellspacing="0" border="0" width="100%">
							<tr>
								<th width="5%" style="text-align:center"><input type="checkbox" id="allcheck" onclick="allCheck(this)"></th>
								<th width="18%">商品编号</th>
								<th width="28%">商品名称</th>
								<th width="17%">商品规格</th>
								<th width="10%">销售类型</th>
								<th width="11%">商品售价(元)</th>
								<th width="11%">商品状态</th> 
								<th width="10%">操作</th>  
							</tr>
						</table>
					</td>
				</tr>
				<tr id="couponType1Td">
					<td class="tdright"><b><font class="f2">*</font>活动类型：</b></td>
					<td colspan="3">
						<select name="useCouponId" id="useCouponId" class="validate[required] data-inputtxt-select">
						<option value="">请选择</option>
						<#if saleTypeList?? && (saleTypeList?size>0)>
							<#list saleTypeList as  li>
							<option value="${li.saleTypeId!''}">${li.saleTypeName!''}</option>	
							</#list>
						</#if>
						</select>
					</td>
				</tr>
			</table>
			<div class="footerbtn">
				<input name="button4" type="button" onClick="javascript:location.href='${Session.BACK_URL!""}'" class="cbtn2" id="button4" value="取消">
				<input name="button3" onclick="beforeSubmit('0');" type="button" class="add-new" id="button3" value="保存草稿">
				<input name="button3" onclick="beforeSubmit('1');" type="button" class="add-new" id="button3" value="立即发布">
			</div>
		</form>
</body>
<script type="text/javascript">
$(function() {
	// 加载验证框架
	$("#createCoupon").validationEngine();
});

function beforeSubmit(type){
	
	
	if ($("#createCoupon").validationEngine('validate')) {
		
		// 判断每日发行量  每日发行量 ≤ 发行总量
		var dayNum = $("#dayNum").val();
		var totalNum  = $("#totalNum").val();
		
		if((dayNum*1)>(totalNum*1)){
			parent.layer.alert("每日发行量不能大于发行总量");
			return ;
		}
		//每人限领
		var obtainLimit  = $("#obtainLimit").val();
		if(obtainLimit * 1 > 10){
			parent.layer.alert("每人限领不能超过10张");
			return ;
		}else if(obtainLimit * 1 < 1){
			parent.layer.alert("每人限领最少1张");
			return ;
		}
		// 每人每天限领
		var dayObtainLimit =$("#dayObtainLimit").val();
		if(dayObtainLimit * 1 > 10){
			parent.layer.alert("每人每天限领不能超过10张");
			return ;
		}else if(dayObtainLimit * 1 < 1){
			parent.layer.alert("每人每天限领最少1张");
			return ;
		}
		
		if(dayObtainLimit*1 > obtainLimit*1){
			parent.layer.alert("每人每天限领不能超过每人限领数量");
			return ;
		}
		
		//判断抵扣金额
		var useType = $("#useType").val();
		if(useType=="1"){
			var discount = $("#discount").val();
			var useLimit = $("#useLimit").val();
			
			if((discount*1)>(useLimit * 0.8)){
				parent.layer.alert("抵扣金额不能大于满足金额的80%");
				return ;
			}
		}else if(useType=="2"){
			var discount = $("#discount").val();
			if(discount * 1 >= 1){
				parent.layer.alert("折扣请填入0-1之间的小数，保留两位小数");
				return ;
			}
		}
		
		var couponType = $("input[name='couponType']:checked").val();
		if(couponType == "2"){
			var sellPriceIdList = $("#sellPriceIdList").val();
			if(sellPriceIdList==""){
				parent.layer.alert("请选择指定商品");
				return ;
			}
		}
			
		if(checkDate()){
			if(couponType == "1"){
				$("#sellPriceIdList").val("");	
			}else{
				$("#useCouponId").val("");
			}
			$("#status").val(type);
			$("#createCoupon").submit();
		}
		
		
	}
}

	//	判断日期
	function checkDate(){
		var result = true;
		
		var validBegin = $("#validBegin").val(); // 券有效期开始
		var validEnd = $("#validEnd").val(); // 券有效期结束
		
		var oDate1 = new Date(validBegin);
	    var oDate2 = new Date(validEnd);
	    if(oDate1.getTime() > oDate2.getTime()){
	    	parent.layer.alert("券有效期结束日期不能大于券有效期开始日期");
	    	result =  false;
	    }
		var obtainDateType  = $("#obtainDateType").val();
		if(obtainDateType=="1"){
			var obtainDateBegin =$("#obtainDateBegin").val();
			var obtainDateEnd = $("#obtainDateEnd").val();
			
			var oDate3 = new Date(obtainDateBegin);
		    var oDate4 = new Date(obtainDateEnd);
		    if(oDate3.getTime() > oDate4.getTime()){
		    	parent.layer.alert("有效时段开始日期不能大于有效时段结束日期");
		    	result =  false;
		    }
		    
		    if(oDate1 > oDate3){
		    	parent.layer.alert("有效时段开始日期不能小于券有效期开始日期");
		    	result =  false;
		    }
		    
		    if(oDate3 > oDate2){
		    	parent.layer.alert("有效时段开始日期不能大于券有效期结束日期");
		    	result =  false;
		    }
		    
		    if(oDate1 > oDate4){
		    	parent.layer.alert("有效时段结束日期不能小于券有效期开始日期");
		    	result =  false;
		    }
		    
		    if(oDate4 > oDate2){
		    	parent.layer.alert("有效时段结束日期不能大于券有效期结束日期");
		    	result =  false;
		    }
		}else if(obtainDateType=="2"){
			var obtainDateSpan = $("#obtainDateSpan").val();
			if(obtainDateSpan<1 || obtainDateSpan>90){
				parent.layer.alert("动态时长请填入1~90之间的数字");
		    	result =  false;
			}
		}
	    return result;
	}

	function changeUserType(){
		var changeUserType = $("#useType").val();
		if(changeUserType=="1"){
			$("#useTypeSpan1").html("抵扣：");
			$("#useTypeSpan2").html("减");
			$("#useTypeSpan3").html("元");
			$("#useTypeSpan4").html("抵扣金额不能大于满足金额的80%");
		}else if(changeUserType=="2"){
			$("#useTypeSpan1").html("折扣：");
			$("#useTypeSpan2").html("打");
			$("#useTypeSpan3").html("折");
			$("#useTypeSpan4").html("请填入0~1之间的小数");
		}
	}
	
	function changeobtainDateType(){
		var obtainDateType = $("#obtainDateType").val();
		if(obtainDateType=="1"){
			$("#obtainDateTypeSpan1").html("<b><span class=\"f2\"><b>*</b></span>有效时段：</b>");
			$("#obtainDateTypeSpan2").show();
			$("#obtainDateTypeSpan3").hide();
			$("#obtainDateSpan").attr("disabled","disabled");
		}else if(obtainDateType=="2"){
			$("#obtainDateTypeSpan1").html("<b><span class=\"f2\"><b>*</b></span>动态时长：</b>");
			$("#obtainDateTypeSpan2").hide();
			$("#obtainDateTypeSpan3").show();
			$("#obtainDateSpan").removeAttr("disabled");
		}
	}
	
	//选择商品相关 start  
	
	function couponTypeChange(type){
		if(type=="1"){
			$("#couponType1Td").show();
			$("#couponType2Td").hide();
		}else{
			$("#couponType2Td").show();
			$("#couponType1Td").hide();
		}
	}
	
	function choosePdc(){
		// 设置 优惠券页面已选择的商品id
		art.dialog.data("sellPriceIdStringOld",$("#sellPriceIdList").val());
		var content = "sellPrice.do?method=queryForCoupon&checkPdc=0&sellPriceIdList="+$("#sellPriceIdList").val();
		parent.layer.open({
			type : 2,
			title : '选择商品',
			area : [ '1320px', '600px' ],
			fix : true,
			content :content,
			end: function(){
				// 已选择的商品 + 新选择的商品
	        	
	        	var sellPriceIdString = art.dialog.data("sellPriceIdString");
				
	        	getCheckPdcPost(sellPriceIdString);
			}
		});
	}
	
	function getCheckPdcPost(sellPriceIdString){
		if(sellPriceIdString!=""){
			$("#sellPriceIdList").val(sellPriceIdString);
			$.post("sellPrice.do?method=queryForCouponPost",{
				checkPdc:1,
				sellPriceIdList:sellPriceIdString
			},function(data){
				$(".checkTr").remove();
				if(data.length>0){
					$("#checkPdcTable").append(getDataHtml(data));
				}
				$("#pdcNum").html($("#checkPdcTable tr").length-1);
			},'json')
		}
	}
	
	function getDataHtml(data){
		var str="";
		for(var i=0;i<data.length;i++){			
			str+='<tr class="checkTr" id="checkPdcTr'+data[i].priceId+'">';
			str+='<td align="center">';
			str+='<input type="checkbox" id="check'+data[i].priceId+'" name="delId" value="'+data[i].priceId+'" onclick="checkPdcInfo(this,\''+data[i].priceId+'\')">';
			str+='</td>';
			str+='<td title="'+data[i].productCode+'">'+data[i].productCode+'</td>'; 
			str+='<td title="'+data[i].productName+'">'+data[i].productName+'</td> ';
			str+='<td title="'+data[i].priceName+'">'+data[i].priceName+'</td> ';
			str+='<td title="'+data[i].saleTypeName+'">'+data[i].saleTypeName+'</td>'; 
			str+='<td style="text-align:right;" title="'+data[i].price+'">'+data[i].price+'</td> ';
			if(data[i].state=="0"){
				str+='<td title="下架">下架</a></td>';
			}else{
				str+='<td title="上架">上架</a></td>';
			}
			str+='<td><a class="ico_btn1" title="删除" href="javascript:void(0);" onclick="delCheckPdc(\''+data[i].priceId+'\')">删除</a>';
			str+='</td> ';
            str+='</tr>';
		}
		return str;
	}
	
	function delCheckPdc(priceId){
		var sellPriceIdList  = $("#sellPriceIdList").val();
		var sellPriceIdListNew = "";
		parent.layer.confirm("确定删除已选商品吗？", function() {
			var checkArray = sellPriceIdList.split(",");
			if(checkArray.length>0){
				for(var i = 0;i<checkArray.length;i++){
					if(checkArray[i]==pdcId){
						checkArray.splice(i,1,"");
						$("#checkPdcTr"+priceId).remove();
					}else{
						if(sellPriceIdListNew!=""){
							sellPriceIdListNew+=",";
						}
						sellPriceIdListNew += checkArray[i];
					}
				}
			}
			 $("#sellPriceIdList").val(sellPriceIdListNew);

			$("#pdcNum").html(sellPriceIdListNew.split(",").length);
			parent.layer.closeAll();
		},function(){
			parent.layer.closeAll();
		});
	}
	
	function delMorePdc(){
		
		var str = "";
		$("input:checkbox[name='delId']:checked").each(function(i) {
			if(str!=""){
				str+=",";
			}
			str+= $(this).val();
		});
		if(str !=""){
			parent.layer.confirm("确定删除已选商品吗？", function() {

				// 原来的pdcList
				var checkArray  = $("#sellPriceIdList").val().split(",");
				
				var checkArrayDel = str.split(",");
				// 新的pdcList
				var sellPriceIdListNew = "";
				if(checkArray.length>0){
					for(var i = 0;i<checkArray.length;i++){
						for(var j = 0;j<checkArrayDel.length;j++){
							if(checkArray[i]==checkArrayDel[j]){
								checkArray.splice(i,1,"");
								$("#checkPdcTr"+checkArrayDel[j]).remove();
								continue;
							}
						}
						if(checkArray[i]!=""){
							if(sellPriceIdListNew!=""){
								sellPriceIdListNew+=",";
							}
							sellPriceIdListNew += checkArray[i];
						}
					}
					
				}
				
				 $("#sellPriceIdList").val(sellPriceIdListNew);
				 if(sellPriceIdListNew==""){
						$("#pdcNum").html(0);
					}else{

						 $("#pdcNum").html(sellPriceIdListNew.split(",").length);
					}
				 $("#allcheck").removeAttr("checked");
				 parent.layer.closeAll();
			},function(){
				parent.layer.closeAll();
			});
		}else{
			parent.layer.alert("请选择要删除的商品")
		}		
	}
	
	//选择商品相关 end  
</script>
</html>
