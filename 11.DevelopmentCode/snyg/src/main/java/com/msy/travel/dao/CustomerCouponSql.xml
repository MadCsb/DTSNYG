<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.msy.travel.dao.CustomerCouponDao" >

	<!-- 新增信息 -->
	<insert id="insertCustomerCoupon" parameterType="customerCoupon">
		INSERT INTO 
			t_sm_customercoupon  
		(
			F_CUSTOMERCOUPONID ,
			F_CUSTOMERCODE ,
			F_COUPONID ,
			F_USETYPE ,
			F_USELIMIT ,
			F_DISCOUNT ,
			F_COUPONTYPE ,
			F_VALIDBEGIN ,
			F_VALIDEND ,
			F_OBTAINTIME ,
			F_STATUS ,
			F_ORDERID ,
			F_DELFLAG 
		) VALUES (
			#{customerCouponId} ,
			#{customerCode} ,
			#{couponId} ,
			#{useType} ,
			#{useLimit} ,
			#{discount} ,
			#{couponType} ,
			#{validBegin} ,
			#{validEnd} ,
			#{obtainTime} ,
			#{status} ,
			#{orderId} ,
			#{delFlag} 
		)
	</insert>

	<!-- 校验信息，主键相同则修改，主键不同则添加 -->
	<insert id="mergeCustomerCoupon" parameterType="customerCoupon">
		REPLACE INTO 
			t_sm_customercoupon 
		(
			F_CUSTOMERCOUPONID ,
			F_CUSTOMERCODE ,
			F_COUPONID ,
			F_USETYPE ,
			F_USELIMIT ,
			F_DISCOUNT ,
			F_COUPONTYPE ,
			F_VALIDBEGIN ,
			F_VALIDEND ,
			F_OBTAINTIME ,
			F_STATUS ,
			F_ORDERID ,
			F_DELFLAG 
		) VALUES (
			#{customerCouponId} ,
			#{customerCode} ,
			#{couponId} ,
			#{useType} ,
			#{useLimit} ,
			#{discount} ,
			#{couponType} ,
			#{validBegin} ,
			#{validEnd} ,
			#{obtainTime} ,
			#{status} ,
			#{orderId} ,
			#{delFlag} 
		)
	</insert>

	<!-- 修改信息 -->
	<update id="updateCustomerCoupon" parameterType="customerCoupon">
		UPDATE
			t_sm_customercoupon
		<set>
			<if test="customerCode !=null">F_CUSTOMERCODE = #{customerCode},</if>
			<if test="couponId !=null">F_COUPONID = #{couponId},</if>
			<if test="useType !=null">F_USETYPE = #{useType},</if>
			<if test="useLimit !=null">F_USELIMIT = #{useLimit},</if>
			<if test="discount !=null">F_DISCOUNT = #{discount},</if>
			<if test="couponType !=null">F_COUPONTYPE = #{couponType},</if>
			<if test="validBegin !=null">F_VALIDBEGIN = #{validBegin},</if>
			<if test="validEnd !=null">F_VALIDEND = #{validEnd},</if>
			<if test="obtainTime !=null">F_OBTAINTIME = #{obtainTime},</if>
			<if test="status !=null">F_STATUS = #{status},</if>
			<if test="orderId !=null">F_ORDERID = #{orderId},</if>
			<if test="delFlag !=null">F_DELFLAG = #{delFlag},</if>
		</set>
		<where>
			F_CUSTOMERCOUPONID = #{customerCouponId}
		</where>
	</update>
	<!-- 删除消息 -->
	<delete id="deleteCustomerCoupon" parameterType="customerCoupon">
		DELETE FROM
			t_sm_customercoupon 
		<where>
			F_CUSTOMERCOUPONID = #{customerCouponId}
			
		</where>
	</delete>
	<!-- 批量删除消息 -->
	<delete id="deleteBatchCustomerCoupon" parameterType="customerCoupon">
		DELETE FROM 
			t_sm_customercoupon 
		<where>
			F_CUSTOMERCOUPONID in
			<foreach collection="customerCouponIdList" item="param" separator="," open="(" close=")">
                   #{param}
            </foreach>
		</where>
	</delete>
	<!-- 查询单个详情 -->
	<select id="queryCustomerCoupon" parameterType="String" resultType="customerCoupon">
		SELECT
			t.F_CUSTOMERCOUPONID as customerCouponId ,
			t.F_CUSTOMERCODE as customerCode ,
			t.F_COUPONID as couponId ,
			t.F_USETYPE as useType ,
			t.F_USELIMIT as useLimit ,
			t.F_DISCOUNT as discount ,
			t.F_COUPONTYPE as couponType ,
			t.F_VALIDBEGIN as validBegin ,
			t.F_VALIDEND as validEnd ,
			t.F_OBTAINTIME as obtainTime ,
			t.F_STATUS as status ,
			t.F_ORDERID as orderId ,
			t.F_DELFLAG as delFlag 
		FROM
			t_sm_customercoupon t
		<where>
			t.F_CUSTOMERCOUPONID = #{customerCouponId} 
			
		</where>
	</select>
	<!-- 按条件查询所有 -->
	<select id="queryCustomerCouponList" parameterType="customerCoupon" resultType="customerCoupon">
		SELECT
			t.F_CUSTOMERCOUPONID as customerCouponId ,
			t.F_CUSTOMERCODE as customerCode ,
			t.F_COUPONID as couponId ,
			t.F_USETYPE as useType ,
			t.F_USELIMIT as useLimit ,
			t.F_DISCOUNT as discount ,
			t.F_COUPONTYPE as couponType ,
			t.F_VALIDBEGIN as validBegin ,
			t.F_VALIDEND as validEnd ,
			t.F_OBTAINTIME as obtainTime ,
			t.F_STATUS as status ,
			t.F_ORDERID as orderId ,
			t.F_DELFLAG as delFlag 
		FROM
		t_sm_customercoupon t
		<where>
			<if test="customerCouponId!=null and customerCouponId!=''">
		    	t.F_CUSTOMERCOUPONID = #{customerCouponId}
		     </if>
			
		</where>
		<if test="entityPage != null">
			<if test="entityPage.sortField !=null and entityPage.sortField !='' ">
		    	ORDER BY ${entityPage.sortField}
			</if>
		</if>	
		<if test="entityPage != null">	
			<if test="entityPage.sortOrder !=null and entityPage.sortOrder !='' ">
		    	${entityPage.sortOrder}
			</if>
		</if>
	</select>
	
	<!-- 获取优惠券总数 -->
	<select id="getCustomerCouponCount" parameterType="customerCoupon" resultType="long">
		SELECT
			COUNT(1) 
		FROM
			t_sm_customercoupon t
		<where>
			<if test="couponId!=null and couponId!=''">
		    	t.F_COUPONID = #{couponId}
		     </if>
		     <if test="obtainTime!=null and obtainTime!=''">
		    	AND t.F_OBTAINTIME = #{obtainTime}
		     </if>
		     <if test="customerCode!=null and customerCode!=''">
		    	AND t.F_CUSTOMERCODE = #{customerCode}
		     </if>
		</where>
	</select>
	<!-- 获取用户优惠券 -->
	<select id="queryCustomerCouponListByUserId" parameterType="customerCoupon" resultType="customerCoupon">
		SELECT
			t.F_COUPONID as couponId ,
			t.F_CUSTOMERCOUPONID as customerCouponId ,
			t.F_CUSTOMERCODE as customerCode ,
			t.F_USETYPE as useType ,
			t.F_USELIMIT as useLimit ,
			t.F_DISCOUNT as discount ,
			t.F_COUPONTYPE as couponType ,
			t.F_VALIDBEGIN as validBegin ,
			t.F_VALIDEND as validEnd ,
			t.F_OBTAINTIME as obtainTime ,
			t.F_STATUS as status ,
			t.F_ORDERID as orderId ,
			t.F_DELFLAG as delFlag ,
			p.F_NAME as name
		FROM
		t_sm_customercoupon t
		LEFT JOIN t_sm_coupon p on t.F_COUPONID = p.F_COUPONID 
		<where>
			<if test="couponId !=null and couponId !=''">
		    	AND t.F_COUPONID = #{couponId}
		    </if>
		    <if test="customerCode !=null and customerCode !=''">
		    	AND t.F_CUSTOMERCODE = #{customerCode}
		    </if>
		    <if test="delFlag !=null and delFlag !=''">
		    	AND t.F_DELFLAG = #{delFlag}
		    </if>
		    <if test="status !=null and status !=''">
		    	AND t.F_STATUS = #{status}
		    </if>
		    <if test="crrObtainDate !=null and crrObtainDate !=''">
		    	AND t.F_VALIDBEGIN &lt;= #{crrObtainDate}
		    </if>
		    <if test="crrObtainDate !=null and crrObtainDate !=''">
		    	AND t.F_VALIDEND &gt;= #{crrObtainDate}
		    </if>
		    <if test='useCouponIdList !=null and useCouponIdList.size()>0'>
		   		AND t.F_COUPONID in (
		   			SELECT DISTINCT(b.F_COUPONID) from t_sm_couponproduction b where  
			   		<foreach collection="useCouponIdList" item="param" separator="or" open="(" close=")">
	                  b.F_USECOUPONID = #{param}
	            	</foreach>
		   		)
	    		
            </if>
		    <if test="timeStatus !=null and timeStatus !=''">
		    	<if test='timeStatus == "4"' >  /*待开始*/
		    		and	<![CDATA[t.F_VALIDBEGIN > date_format(now(),'%Y-%m-%d')]]>
		    	</if>
		    	<if test='timeStatus == "5"' > /*进行中*/
		    		and	<![CDATA[t.F_VALIDBEGIN <= date_format(now(),'%Y-%m-%d')]]>
					and <![CDATA[t.F_VALIDEND >= date_format(now(),'%Y-%m-%d')]]>
		    	</if>
		    	<if test='timeStatus == "6"' >/*已结束*/
		    		and	<![CDATA[t.F_VALIDEND < date_format(now(),'%Y-%m-%d')]]>
		    	</if>
		    	<if test='timeStatus == "7"' >/*可使用*/
		    		and((<![CDATA[t.F_VALIDBEGIN <= date_format(now(),'%Y-%m-%d')]]>
					and <![CDATA[t.F_VALIDEND >= date_format(now(),'%Y-%m-%d')]]>) or <![CDATA[t.F_VALIDBEGIN > date_format(now(),'%Y-%m-%d')]]>) 
				</if>
		     </if>
		</where>
	  	ORDER BY F_OBTAINTIME DESC
	</select>
</mapper>	