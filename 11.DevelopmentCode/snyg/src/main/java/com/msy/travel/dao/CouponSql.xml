<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.msy.travel.dao.CouponDao" >

	<!-- 新增信息 -->
	<insert id="insertCoupon" parameterType="coupon">
		INSERT INTO 
			t_sm_coupon  
		(
			F_COUPONID ,
			F_SPID ,
			F_NAME ,
			F_OBTAINTYPE ,
			F_TOTALNUM ,
			F_DAYNUM ,
			F_USETYPE ,
			F_USELIMIT ,
			F_DISCOUNT ,
			F_OBTAINLIMIT ,
			F_DAYOBTAINLIMIT ,
			F_VALIDBEGIN ,
			F_VALIDEND ,
			F_OBTAINDATETYPE ,
			F_OBTAINDATEBEGIN ,
			F_OBTAINDATEEND ,
			F_OBTAINDATESPAN ,
			F_COUPONTYPE ,
			F_STATUS ,
			F_CREATETIME ,
			F_CREATORUID ,
			F_CREATOR ,
			F_UPDATETIME ,
			F_UPDATERUID ,
			F_UPDATER ,
			F_DELFLAG ,
			F_COUPONTAG ,
			F_PCOUPONID 
		) VALUES (
			#{couponId} ,
			#{spId} ,
			#{name} ,
			#{obtainType} ,
			#{totalNum} ,
			#{dayNum} ,
			#{useType} ,
			#{useLimit} ,
			#{discount} ,
			#{obtainLimit} ,
			#{dayObtainLimit} ,
			#{validBegin} ,
			#{validEnd} ,
			#{obtainDateType} ,
			#{obtainDateBegin} ,
			#{obtainDateEnd} ,
			#{obtainDateSpan} ,
			#{couponType} ,
			#{status} ,
			#{createTime} ,
			#{creatorUid} ,
			#{creator} ,
			#{updateTime} ,
			#{updaterUid} ,
			#{updater} ,
			#{delFlag} ,
			#{couponTag} ,
			#{pcouponId} 
		)
	</insert>

	<!-- 校验信息，主键相同则修改，主键不同则添加 -->
	<insert id="mergeCoupon" parameterType="coupon">
		REPLACE INTO 
			t_sm_coupon 
		(
			F_COUPONID ,
			F_SPID ,
			F_NAME ,
			F_OBTAINTYPE ,
			F_TOTALNUM ,
			F_DAYNUM ,
			F_USETYPE ,
			F_USELIMIT ,
			F_DISCOUNT ,
			F_OBTAINLIMIT ,
			F_DAYOBTAINLIMIT ,
			F_VALIDBEGIN ,
			F_VALIDEND ,
			F_OBTAINDATETYPE ,
			F_OBTAINDATEBEGIN ,
			F_OBTAINDATEEND ,
			F_OBTAINDATESPAN ,
			F_COUPONTYPE ,
			F_STATUS ,
			F_CREATETIME ,
			F_CREATORUID ,
			F_CREATOR ,
			F_UPDATETIME ,
			F_UPDATERUID ,
			F_UPDATER ,
			F_DELFLAG ,
			F_COUPONTAG ,
			F_PCOUPONID 
		) VALUES (
			#{couponId} ,
			#{spId} ,
			#{name} ,
			#{obtainType} ,
			#{totalNum} ,
			#{dayNum} ,
			#{useType} ,
			#{useLimit} ,
			#{discount} ,
			#{obtainLimit} ,
			#{dayObtainLimit} ,
			#{validBegin} ,
			#{validEnd} ,
			#{obtainDateType} ,
			#{obtainDateBegin} ,
			#{obtainDateEnd} ,
			#{obtainDateSpan} ,
			#{couponType} ,
			#{status} ,
			#{createTime} ,
			#{creatorUid} ,
			#{creator} ,
			#{updateTime} ,
			#{updaterUid} ,
			#{updater} ,
			#{delFlag} ,
			#{couponTag} ,
			#{pcouponId} 
		)
	</insert>

	<!-- 修改信息 -->
	<update id="updateCoupon" parameterType="coupon">
		UPDATE
			t_sm_coupon 
		SET
			F_NAME = #{name} ,
			F_OBTAINTYPE = #{obtainType} ,
			F_TOTALNUM = #{totalNum} ,
			F_DAYNUM = #{dayNum} ,
			F_USETYPE = #{useType} ,
			F_USELIMIT = #{useLimit} ,
			F_DISCOUNT = #{discount} ,
			F_OBTAINLIMIT = #{obtainLimit} ,
			F_DAYOBTAINLIMIT = #{dayObtainLimit} ,
			F_VALIDBEGIN = #{validBegin} ,
			F_VALIDEND = #{validEnd} ,
			F_OBTAINDATETYPE = #{obtainDateType} ,
			F_OBTAINDATEBEGIN = #{obtainDateBegin} ,
			F_OBTAINDATEEND = #{obtainDateEnd} ,
			F_OBTAINDATESPAN = #{obtainDateSpan} ,
			F_COUPONTYPE = #{couponType} ,
			F_STATUS = #{status} ,
			F_UPDATETIME = #{updateTime} ,
			F_UPDATERUID = #{updaterUid} ,
			F_UPDATER = #{updater} ,
			F_DELFLAG = #{delFlag} ,
			F_COUPONTAG = #{couponTag} ,
			F_PCOUPONID = #{pcouponId} 
		<where>
			F_COUPONID = #{couponId} 
			
		</where>
	</update>
	<!-- 删除消息 -->
	<delete id="deleteCoupon" parameterType="coupon">
		DELETE FROM
			t_sm_coupon 
		<where>
			F_COUPONID = #{couponId}
			
		</where>
	</delete>
	<!-- 批量删除消息 -->
	<delete id="deleteBatchCoupon" parameterType="coupon">
		DELETE FROM 
			t_sm_coupon 
		<where>
			F_COUPONID in
			<foreach collection="couponIdList" item="param" separator="," open="(" close=")">
                   #{param}
            </foreach>
		</where>
	</delete>
	<!-- 查询单个详情 -->
	<select id="queryCoupon" parameterType="String" resultType="coupon">
		SELECT
			t.F_COUPONID as couponId ,
			t.F_SPID as spId ,
			t.F_NAME as name ,
			t.F_OBTAINTYPE as obtainType ,
			t.F_TOTALNUM as totalNum ,
			t.F_DAYNUM as dayNum ,
			t.F_USETYPE as useType ,
			t.F_USELIMIT as useLimit ,
			t.F_DISCOUNT as discount ,
			t.F_OBTAINLIMIT as obtainLimit ,
			t.F_DAYOBTAINLIMIT as dayObtainLimit ,
			t.F_VALIDBEGIN as validBegin ,
			t.F_VALIDEND as validEnd ,
			t.F_OBTAINDATETYPE as obtainDateType ,
			t.F_OBTAINDATEBEGIN as obtainDateBegin ,
			t.F_OBTAINDATEEND as obtainDateEnd ,
			t.F_OBTAINDATESPAN as obtainDateSpan ,
			t.F_COUPONTYPE as couponType ,
			t.F_STATUS as status ,
			t.F_CREATETIME as createTime ,
			t.F_CREATORUID as creatorUid ,
			t.F_CREATOR as creator ,
			t.F_UPDATETIME as updateTime ,
			t.F_UPDATERUID as updaterUid ,
			t.F_UPDATER as updater ,
			t.F_DELFLAG as delFlag ,
			t.F_COUPONTAG as couponTag ,
			t.F_PCOUPONID as pcouponId 
		FROM
			t_sm_coupon t
		<where>
			t.F_COUPONID = #{couponId} 
			
		</where>
	</select>
	<!-- 按条件查询所有 -->
	<select id="queryCouponList" parameterType="coupon" resultType="coupon">
		SELECT
			t.F_COUPONID as couponId ,
			t.F_SPID as spId ,
			t.F_NAME as name ,
			t.F_OBTAINTYPE as obtainType ,
			t.F_TOTALNUM as totalNum ,
			t.F_DAYNUM as dayNum ,
			t.F_USETYPE as useType ,
			t.F_USELIMIT as useLimit ,
			t.F_DISCOUNT as discount ,
			t.F_OBTAINLIMIT as obtainLimit ,
			t.F_DAYOBTAINLIMIT as dayObtainLimit ,
			t.F_VALIDBEGIN as validBegin ,
			t.F_VALIDEND as validEnd ,
			t.F_OBTAINDATETYPE as obtainDateType ,
			t.F_OBTAINDATEBEGIN as obtainDateBegin ,
			t.F_OBTAINDATEEND as obtainDateEnd ,
			t.F_OBTAINDATESPAN as obtainDateSpan ,
			t.F_COUPONTYPE as couponType ,
			t.F_STATUS as status ,
			t.F_CREATETIME as createTime ,
			t.F_CREATORUID as creatorUid ,
			t.F_CREATOR as creator ,
			t.F_UPDATETIME as updateTime ,
			t.F_UPDATERUID as updaterUid ,
			t.F_UPDATER as updater ,
			t.F_DELFLAG as delFlag ,
			t.F_COUPONTAG as couponTag ,
			t.F_PCOUPONID as pcouponId ,
			t.F_TOTALNUM - IFNULL(cp.F_SURPLUS,0) as surplus,
			cup.F_CUSTOMERUSENUM as customerUseNum
		FROM
		t_sm_coupon t
		left join (select count(1) as F_SURPLUS,F_COUPONID from t_sm_customercoupon group by F_COUPONID ) cp on cp.F_COUPONID=t.F_COUPONID 
		left join (select count(DISTINCT(F_CUSTOMERCODE)) as F_CUSTOMERUSENUM,F_COUPONID from t_sm_customercoupon where F_STATUS=1 group by F_COUPONID) cup on cup.F_COUPONID=t.F_COUPONID
		<where>
			<if test="couponId!=null and couponId!=''">
		    	t.F_COUPONID = #{couponId}
		     </if>
		     <if test="name!=null and name!=''">
		    	and t.F_NAME like concat('%',#{name},'%') 
		     </if>
		     <if test='dateType!=null and dateType=="0"'>
		    	<if test="dateStart!=null and dateStart!=''">
		    		and t.F_OBTAINDATEBEGIN >= #{dateStart}
		     	</if>
		     	<if test="dateEnd!=null and dateEnd!=''">
		    		and t.F_OBTAINDATEEND &lt;= #{dateEnd}
		     	</if>
		     </if>
		     <if test='dateType!=null and dateType=="1"'>
		    	<if test="dateStart!=null and dateStart!=''">
		    		and t.F_VALIDBEGIN >= #{dateStart}
		     	</if>
		     	<if test="dateEnd!=null and dateEnd!=''">
		    		and t.F_VALIDEND &lt;= #{dateEnd}
		     	</if>
		     </if>
		     <if test="status!=null and status!=''">
		    	<if test='status=="0" || status=="2" || status=="3"' >
		    		and t.F_STATUS = #{status}
		    	</if>
		    	<if test='status=="4"' >
		    		and	<![CDATA[t.F_VALIDBEGIN > date_format(now(),'%Y-%m-%d')]]>
		    		and t.F_STATUS =1
		    	</if>
		    	<if test='status=="5"' >
		    		and	<![CDATA[t.F_VALIDBEGIN <= date_format(now(),'%Y-%m-%d')]]>
					and <![CDATA[t.F_VALIDEND >= date_format(now(),'%Y-%m-%d')]]>
					and t.F_STATUS =1
		    	</if>
		    	<if test='status=="6"' >
		    		and	<![CDATA[t.F_VALIDEND < date_format(now(),'%Y-%m-%d')]]>
		    		and t.F_STATUS =1
		    	</if>
		     </if>
		     <if test="spId !=null and spId !=''">
		    	and t.F_SPID = #{spId} 
		     </if>
		     <if test="couponTag !=null and couponTag !=''">
		    	and t.F_COUPONTAG = #{couponTag} 
		     </if>
		</where>
		<if test="entityPage != null">
			<if test="entityPage.sortField !=null and entityPage.sortField !='' ">
		    	ORDER BY ${entityPage.sortField}
			</if>
		</if>	
		<if test="entityPage != null">	
			<if test="entityPage.sortOrder !=null and entityPage.sortOrder !='' ">
		    	${entityPage.sortOrder}
			</if>
		</if>
	</select>
	<!-- 领取页获取优惠券以及已领优惠券 (用户登录查询) -->
	<select id="queryCouponListForSellPriceLogin" parameterType="coupon" resultType="coupon">
		SELECT 
			b.*
		FROM
			(
				SELECT 
					a1.*,
					IFNULL(a2.receiveCount,0) as receiveCount,
					IFNULL(a3.todayCount,0) as todayCount
				FROM
				(
					SELECT 
						DISTINCT t.F_COUPONID as couponId ,
						t.F_SPID as spId ,
						t.F_NAME as name ,
						t.F_OBTAINTYPE as obtainType ,
						t.F_TOTALNUM as totalNum ,
						t.F_DAYNUM as dayNum ,
						t.F_USETYPE as useType ,
						t.F_USELIMIT as useLimit ,
						t.F_DISCOUNT as discount ,
						t.F_OBTAINLIMIT as obtainLimit ,
						t.F_DAYOBTAINLIMIT as dayObtainLimit ,
						t.F_VALIDBEGIN as validBegin ,
						t.F_VALIDEND as validEnd ,
						t.F_OBTAINDATETYPE as obtainDateType ,
						t.F_OBTAINDATEBEGIN as obtainDateBegin ,
						t.F_OBTAINDATEEND as obtainDateEnd ,
						t.F_OBTAINDATESPAN as obtainDateSpan ,
						t.F_COUPONTYPE as couponType ,
						t.F_STATUS as status ,
						t.F_CREATETIME as createTime ,
						t.F_CREATORUID as creatorUid ,
						t.F_CREATOR as creator ,
						t.F_UPDATETIME as f_UPDATETIME ,
						t.F_UPDATERUID as updaterUid ,
						t.F_UPDATER as updater ,
						t.F_DELFLAG as delFlag  
					FROM 
						t_sm_coupon t 
					LEFT JOIN 
						t_sm_couponproduction b ON (t.F_COUPONID = b.F_COUPONID)
					WHERE 
						t.F_STATUS = '1'
					AND  
						t.F_OBTAINTYPE = '1'
					AND t.F_COUPONTAG = '1'
					AND t.F_DELFLAG='0'
					AND 
						#{crrObtainDate} >= t.F_OBTAINDATEBEGIN 
				    AND 
				    	t.F_OBTAINDATEEND >= #{crrObtainDate}
				    <if test='useCouponIdList !=null and useCouponIdList.size()>0'>
				    AND
			    		<foreach collection="useCouponIdList" item="param" separator="or" open="(" close=")">
		                  b.F_USECOUPONID = #{param}
		            	</foreach>
		            </if>
					) a1
				LEFT JOIN (SELECT F_COUPONID,COUNT(1) AS receiveCount FROM t_sm_customercoupon WHERE F_CUSTOMERCODE=#{userId} GROUP BY F_COUPONID) a2 on (a1.couponId = a2.F_COUPONID)
				LEFT JOIN (SELECT F_COUPONID,COUNT(1) AS todayCount FROM t_sm_customercoupon WHERE F_CUSTOMERCODE=#{userId} AND F_OBTAINTIME=#{crrObtainDate} GROUP BY F_COUPONID) a3 on (a1.couponId = a3.F_COUPONID)
			) b
		WHERE 
			b.obtainLimit > b.receiveCount
		AND 
			b.dayObtainLimit > b.todayCount
		ORDER BY 
			b.discount DESC ,b.validEnd
	</select>
	
	<!-- 领取页获取优惠券以及已领优惠券 (用户未登录查询) -->
	<select id="queryCouponListForSellPriceNoLogin" parameterType="coupon" resultType="coupon">
		SELECT 
			b.*
		FROM
			(
				SELECT 
					a1.*
				FROM
				(
					SELECT 
						DISTINCT t.F_COUPONID as couponId ,
						t.F_SPID as spId ,
						t.F_NAME as name ,
						t.F_OBTAINTYPE as obtainType ,
						t.F_TOTALNUM as totalNum ,
						t.F_DAYNUM as dayNum ,
						t.F_USETYPE as useType ,
						t.F_USELIMIT as useLimit ,
						t.F_DISCOUNT as discount ,
						t.F_OBTAINLIMIT as obtainLimit ,
						t.F_DAYOBTAINLIMIT as dayObtainLimit ,
						t.F_VALIDBEGIN as validBegin ,
						t.F_VALIDEND as validEnd ,
						t.F_OBTAINDATETYPE as obtainDateType ,
						t.F_OBTAINDATEBEGIN as obtainDateBegin ,
						t.F_OBTAINDATEEND as obtainDateEnd ,
						t.F_OBTAINDATESPAN as obtainDateSpan ,
						t.F_COUPONTYPE as couponType ,
						t.F_STATUS as status ,
						t.F_CREATETIME as createTime ,
						t.F_CREATORUID as creatorUid ,
						t.F_CREATOR as creator ,
						t.F_UPDATETIME as f_UPDATETIME ,
						t.F_UPDATERUID as updaterUid ,
						t.F_UPDATER as updater ,
						t.F_DELFLAG as delFlag  
					FROM 
						t_sm_coupon t 
					LEFT JOIN 
						t_sm_couponproduction b ON (t.F_COUPONID = b.F_COUPONID)
					WHERE 
						t.F_STATUS = '1'
					AND  
						t.F_OBTAINTYPE = '1'
					AND t.F_COUPONTAG = '1'
					AND t.F_DELFLAG='0'
					AND 
						#{crrObtainDate} >= t.F_OBTAINDATEBEGIN 
				    AND 
				    	t.F_OBTAINDATEEND >= #{crrObtainDate}
				    <if test='useCouponIdList !=null and useCouponIdList.size()>0'>
				    AND
			    		<foreach collection="useCouponIdList" item="param" separator="or" open="(" close=")">
		                  b.F_USECOUPONID = #{param}
		            	</foreach>
		            </if>
					) a1
			) b
		/*
		WHERE 
			b.obtainLimit > b.receiveCount
		AND 
			b.dayObtainLimit > b.todayCount*/
		ORDER BY 
			b.discount DESC ,b.validEnd
	</select>
	
	
	<!-- 活动页优惠券检索 未登录-->
	<select id="queryCouponListBySquareNoLogin" parameterType="coupon" resultType="coupon">
		SELECT 
			b.F_COUPONID as couponId ,
			b.F_SPID as spId ,
			b.F_NAME as name ,
			b.F_OBTAINTYPE as obtainType ,
			b.F_TOTALNUM as totalNum ,
			b.F_DAYNUM as dayNum ,
			b.F_USETYPE as useType ,
			b.F_USELIMIT as useLimit ,
			b.F_DISCOUNT as discount ,
			b.F_OBTAINLIMIT as obtainLimit ,
			b.F_DAYOBTAINLIMIT as dayObtainLimit ,
			b.F_VALIDBEGIN as validBegin ,
			b.F_VALIDEND as validEnd ,
			b.F_OBTAINDATETYPE as obtainDateType ,
			b.F_OBTAINDATEBEGIN as obtainDateBegin ,
			b.F_OBTAINDATEEND as obtainDateEnd ,
			b.F_OBTAINDATESPAN as obtainDateSpan ,
			b.F_COUPONTYPE as couponType ,
			b.F_STATUS as status ,
			b.F_CREATETIME as createTime ,
			b.F_CREATORUID as creatorUid ,
			b.F_CREATOR as creator ,
			b.F_UPDATETIME as f_UPDATETIME ,
			b.F_UPDATERUID as updaterUid ,
			b.F_UPDATER as updater ,
			b.F_DELFLAG as delFlag 
		FROM
			(
				SELECT 
					a1.*
				FROM
				(
					SELECT 
						t.*
				 	FROM (
						SELECT
							*
						FROM
							t_sm_coupon t1
						WHERE
							t1.F_STATUS = '1'
						AND
						    t1.F_OBTAINTYPE = '2'
						AND t1.F_COUPONTAG = '1'
						AND t1.F_DELFLAG='0'
						AND
							#{crrObtainDate} >= t1.F_OBTAINDATEBEGIN 
				    	AND 
				    		t1.F_OBTAINDATEEND >= #{crrObtainDate}
					) t
				) a1
			) b
		ORDER BY 
			b.F_DISCOUNT DESC ,b.F_VALIDEND
	</select>
	
	<!-- 活动页优惠券检索 已登录-->
	<select id="queryCouponListBySquareLogin" parameterType="coupon" resultType="coupon">
		SELECT 
			b.F_COUPONID as couponId ,
			b.F_SPID as spId ,
			b.F_NAME as name ,
			b.F_OBTAINTYPE as obtainType ,
			b.F_TOTALNUM as totalNum ,
			b.F_DAYNUM as dayNum ,
			b.F_USETYPE as useType ,
			b.F_USELIMIT as useLimit ,
			b.F_DISCOUNT as discount ,
			b.F_OBTAINLIMIT as obtainLimit ,
			b.F_DAYOBTAINLIMIT as dayObtainLimit ,
			b.F_VALIDBEGIN as validBegin ,
			b.F_VALIDEND as validEnd ,
			b.F_OBTAINDATETYPE as obtainDateType ,
			b.F_OBTAINDATEBEGIN as obtainDateBegin ,
			b.F_OBTAINDATEEND as obtainDateEnd ,
			b.F_OBTAINDATESPAN as obtainDateSpan ,
			b.F_COUPONTYPE as couponType ,
			b.F_STATUS as status ,
			b.F_CREATETIME as createTime ,
			b.F_CREATORUID as creatorUid ,
			b.F_CREATOR as creator ,
			b.F_UPDATETIME as f_UPDATETIME ,
			b.F_UPDATERUID as updaterUid ,
			b.F_UPDATER as updater ,
			b.F_DELFLAG as delFlag ,
			b.receiveCount,
			b.todayCount
		FROM
			(
				SELECT 
					a1.*,
					IFNULL(a2.receiveCount,0) as receiveCount,
					IFNULL(a3.todayCount,0) as todayCount
				FROM
				(
					SELECT 
						t.*
				 	FROM (
						SELECT
							*
						FROM
							t_sm_coupon t1
						WHERE
							t1.F_STATUS = '1'
						AND
						    t1.F_OBTAINTYPE = '2'
						AND t1.F_COUPONTAG = '1'
						AND t1.F_DELFLAG='0'
						AND
							#{crrObtainDate} >= t1.F_OBTAINDATEBEGIN 
				    	AND 
				    		t1.F_OBTAINDATEEND >= #{crrObtainDate}
					) t
				) a1
				LEFT JOIN (SELECT F_COUPONID,COUNT(1) AS receiveCount FROM t_sm_customercoupon WHERE F_CUSTOMERCODE=#{userId} GROUP BY F_COUPONID) a2 on (a1.F_COUPONID = a2.F_COUPONID)
				LEFT JOIN (SELECT F_COUPONID,COUNT(1) AS todayCount FROM t_sm_customercoupon WHERE F_CUSTOMERCODE=#{userId} AND F_OBTAINTIME=#{crrObtainDate} GROUP BY F_COUPONID) a3 on (a1.F_COUPONID = a3.F_COUPONID)
			) b
		/*
		WHERE 
			b.F_OBTAINLIMIT > b.receiveCount
		AND 
			b.F_DAYOBTAINLIMIT > b.todayCount*/
		ORDER BY 
			b.F_DISCOUNT DESC ,b.F_VALIDEND
	</select>
</mapper>	